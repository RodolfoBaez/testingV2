{% extends "base.html" %}
{% block title %}Wizard Graph{% endblock %}
{% block content %}
<div class="container d-flex flex-column justify-content-center align-items-center" style="height: 100vh; padding: 20px;">
    <h1 class="my-4 text-center">Wizard Graph</h1>

    <!-- Plot Section -->
    <div id="plot" style="width: 100%; max-width: 800px; height: 400px;"></div>

    <!-- Table Section -->
    <div id="table" class="mt-4" style="max-width: 800px; width: 100%; overflow-x: auto;"></div>

    <!-- Buttons -->
    <div class="mt-4">
        <button id="saveGraphButton" class="btn btn-primary">Save Graph as PNG</button>
        <button id="saveCSVButton" class="btn btn-secondary">Save Plot Points as CSV</button>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // Retrieve graph settings from the server
    const graphSettings = {{ graph_settings|tojson|safe }};

    // Generate sample data for the graph based on settings
    const xValues = Array.from({ length: 50 }, (_, i) => i); // X-axis values
    const yValues = xValues.map(x => Math.sin(x / 5) + Math.random() * 0.2); // Y-axis values

    // Plot the graph
    const trace = {
        x: xValues,
        y: yValues,
        mode: 'lines+markers',
        type: 'scatter',
        line: { shape: 'spline' } // Smooth curve
    };

    const layout = {
        title: {
            text: `Graph Type: ${graphSettings.graph_type}`,
            x: 0.5,
            y: 0.95,
            xanchor: 'center',
            yanchor: 'top'
        },
        xaxis: { title: 'X-Axis' },
        yaxis: { title: 'Y-Axis' },
        margin: { t: 50, b: 50, l: 50, r: 50 },
        plot_bgcolor: '#f9f9f9'
    };

    Plotly.newPlot('plot', [trace], layout);

    // Create the table
    const tableContainer = document.getElementById('table');
    let tableHtml = `<table class="table table-striped table-sm"><thead><tr><th>X</th><th>Y</th></tr></thead><tbody>`;
    for (let i = 0; i < xValues.length; i++) {
        tableHtml += `<tr><td>${xValues[i]}</td><td>${yValues[i].toFixed(2)}</td></tr>`;
    }
    tableHtml += '</tbody></table>';
    tableContainer.innerHTML = tableHtml;

    // Save graph as PNG
    document.getElementById('saveGraphButton').addEventListener('click', function () {
        Plotly.toImage('plot', { format: 'png', width: 800, height: 400 })
            .then(function (dataUrl) {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'graph.png';
                link.click();
            });
    });

    // Save plot points as CSV
    document.getElementById('saveCSVButton').addEventListener('click', function () {
        const csvContent = 'data:text/csv;charset=utf-8,' +
            'X,Y\n' +
            xValues.map((x, i) => `${x},${yValues[i].toFixed(2)}`).join('\n');
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.href = encodedUri;
        link.download = 'plot_points.csv';
        link.click();
    });
</script>
{% endblock %}
