{% extends "base.html" %}
{% block title %}Parameter Settings{% endblock %}
{% block content %}
<h2 class="mt-5 text-center">HP4280A Parameter Settings</h2>

<!-- Terminal Output Section -->
<div class="alert {{ 'alert-success' if connection_status == 'success' else 'alert-danger' }} my-4">
    {% for line in terminal_output %}
        <p>{{ line }}</p>
    {% endfor %}
</div>

<!-- Parameter Settings Form -->
<form action="/parameter" method="post" class="p-4 border rounded shadow-sm bg-white mb-5">
    <!-- Measurement Type Selector -->
    <div class="mb-3">
        <label for="measurement_type" class="form-label">Measurement Type:</label>
        <select class="form-select" id="measurement_type" name="measurement_type" required>
            <option value="cv" selected>C-V Measurement</option>
            <option value="ct">C-T Measurement</option>
        </select>
    </div>

    <!-- C-V Measurement Fields -->
    <div id="cv_settings">
        <div class="mb-3">
            <label for="DC_V" class="form-label">DC Voltage (DC_V):</label>
            <input type="number" step="0.01" class="form-control" id="DC_V" name="DC_V" value="{{ settings.DC_V }}" required>
        </div>
        <div class="mb-3">
            <label for="Start_V" class="form-label">Start Voltage (Start_V):</label>
            <input type="number" step="0.01" class="form-control" id="Start_V" name="Start_V" value="{{ settings.Start_V }}" required>
        </div>
        <div class="mb-3">
            <label for="Stop_V" class="form-label">Stop Voltage (Stop_V):</label>
            <input type="number" step="0.01" class="form-control" id="Stop_V" name="Stop_V" value="{{ settings.Stop_V }}" required>
        </div>
        <div class="mb-3">
            <label for="Step_V" class="form-label">Step Voltage (Step_V):</label>
            <input type="number" step="0.01" class="form-control" id="Step_V" name="Step_V" value="{{ settings.Step_V }}" required>
        </div>
        <div class="mb-3">
            <label for="Hold_T" class="form-label">Hold Time (Hold_T):</label>
            <input type="number" step="0.01" class="form-control" id="Hold_T" name="Hold_T" value="{{ settings.Hold_T }}" required>
        </div>
        <div class="mb-3">
            <label for="Step_T" class="form-label">Step Time (Step_T):</label>
            <input type="number" step="0.01" class="form-control" id="Step_T" name="Step_T" value="{{ settings.Step_T }}" required>
        </div>
        <div class="mb-3 text-center">
            <button type="submit" name="action" value="start_pulse_sweep" class="btn btn-outline-warning" id="pulse_sweep_button">Start Pulse Sweep</button>
        </div>
    </div>

    <!-- C-T Measurement Fields -->
    <div id="ct_settings" style="display: none;">
        <div class="mb-3">
            <label for="Pulse" class="form-label">Pulse (V):</label>
            <input type="number" step="0.01" class="form-control" id="Pulse" name="Pulse" value="0">
        </div>
        <div class="mb-3">
            <label for="Meas" class="form-label">MEAS:</label>
            <input type="number" step="0.01" class="form-control" id="Meas" name="Meas" value="0">
        </div>
        <div class="mb-3">
            <label for="Nofread" class="form-label"># OF READING:</label>
            <input type="number" step="1" class="form-control" id="Nofread" name="Nofread" value="10">
        </div>
        <div class="mb-3">
            <label for="Pulse_Width" class="form-label">Pulse Width (s):</label>
            <input type="number" step="0.01" class="form-control" id="Pulse_Width" name="Pulse_Width" value="1">
        </div>
        <div class="mb-3">
            <label for="Meas_Interval" class="form-label">MEAS Interval (s):</label>
            <input type="number" step="0.01" class="form-control" id="Meas_Interval" name="Meas_Interval" value="0.1">
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-between">
        <button type="submit" name="action" value="update_settings" class="btn btn-outline-primary">Update Settings</button>
        <button type="submit" name="action" value="start_measurement" class="btn btn-outline-success">Start Measurement</button>
    </div>
</form>

<div class="mt-4 text-center">
    <a href="/configuration" class="btn btn-outline-secondary">Back to Configuration</a>
</div>

<script>
    // Call this function when the parameter page loads
    document.addEventListener('DOMContentLoaded', function() {
        restrictMeasurementType();
    });
    
    // Show/Hide Settings Based on Measurement Type
    const measurementType = document.getElementById("measurement_type");
    const cvSettings = document.getElementById("cv_settings");
    const ctSettings = document.getElementById("ct_settings");

    measurementType.addEventListener("change", function () {
        if (this.value === "ct") {
            cvSettings.style.display = "none";
            ctSettings.style.display = "block";
        } else {
            cvSettings.style.display = "block";
            ctSettings.style.display = "none";
        }
    });

    // Function to restrict measurement type based on configuration selection
    function restrictMeasurementType() {
    const measurementTypeSelect = document.getElementById('measurement_type');
    const savedType = localStorage.getItem('measurement_type');
    
    // If there's a saved type from the config page
    if (savedType) {
        // Set the value
        measurementTypeSelect.value = savedType;
        
        // Disable changing the selection
        measurementTypeSelect.disabled = true;
        
        // Add a note that this was set from configuration
        const noteElement = document.createElement('small');
        noteElement.className = 'form-text text-muted';
        noteElement.textContent = 'This measurement type was set from the configuration page.';
        measurementTypeSelect.parentNode.appendChild(noteElement);
        
        // Also trigger the display logic immediately
        if (savedType === 'ct') {
            document.getElementById('cv_settings').style.display = 'none';
            document.getElementById('ct_settings').style.display = 'block';
        } else {
            document.getElementById('cv_settings').style.display = 'block';
            document.getElementById('ct_settings').style.display = 'none';
        }
    }
}

    // Initialize the correct settings on page load
    document.addEventListener("DOMContentLoaded", function () {
        if (measurementType.value === "ct") {
            cvSettings.style.display = "none";
            ctSettings.style.display = "block";
        } else {
            cvSettings.style.display = "block";
            ctSettings.style.display = "none";
        }
    });
</script>
{% endblock %}
